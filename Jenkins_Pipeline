pipeline {
    agent any

    environment {
        REGISTRY       = 'microserviceacr.azurecr.io'    // ACR login server
        RESOURCE_GROUP = 'devops-assignment-rg'          // Azure Resource Group
        AKS_CLUSTER    = 'devops-aks'                    // AKS Cluster name
        IMAGE_TAG      = "${env.BUILD_NUMBER}"           // Image tag per build
        DOCKER_CREDENTIALS_ID = 'azure-docker-credentials' // Jenkins credentials ID for ACR
        AZURE_CREDENTIALS_ID  = 'azure-service-principal'  // Jenkins credentials ID for Azure login
    }

    stages {
        stage('Checkout Code') {
            steps {
                git branch: 'main', url: 'https://github.com/iamnkit/microservices-project.git'
            }
        }

        stage('Build Docker Images') {
            steps {
                script {
                    echo "üõ† Building Docker images for all microservices..."
                    docker.build("user-service:${IMAGE_TAG}", './user-service')
                    docker.build("order-service:${IMAGE_TAG}", './order-service')
                    docker.build("api-gateway:${IMAGE_TAG}", './api-gateway')
                }
            }
        }

        stage('Push Images to ACR') {
            steps {
                withCredentials([usernamePassword(credentialsId: "${DOCKER_CREDENTIALS_ID}", usernameVariable: 'USERNAME', passwordVariable: 'PASSWORD')]) {
                    sh '''
                    echo $PASSWORD | docker login ${REGISTRY} -u $USERNAME --password-stdin
                    
                    # Tag images
                    docker tag user-service:${IMAGE_TAG} ${REGISTRY}/user-service:${IMAGE_TAG}
                    docker tag order-service:${IMAGE_TAG} ${REGISTRY}/order-service:${IMAGE_TAG}
                    docker tag api-gateway:${IMAGE_TAG} ${REGISTRY}/api-gateway:${IMAGE_TAG}
                    
                    # Push to ACR
                    docker push ${REGISTRY}/user-service:${IMAGE_TAG}
                    docker push ${REGISTRY}/order-service:${IMAGE_TAG}
                    docker push ${REGISTRY}/api-gateway:${IMAGE_TAG}
                    '''
                }
            }
        }

        stage('Deploy to AKS') {
            steps {
                withCredentials([azureServicePrincipal(credentialsId: "${AZURE_CREDENTIALS_ID}")]) {
                    sh '''
                    echo "üì¶ Deploying to AKS..."
                    az aks get-credentials --resource-group ${RESOURCE_GROUP} --name ${AKS_CLUSTER} --overwrite-existing
                    
                    # Apply Kubernetes manifests
                    kubectl apply -f k8s/
                    
                    # Wait for deployments to complete
                    kubectl rollout status deployment/user-service
                    kubectl rollout status deployment/order-service
                    kubectl rollout status deployment/api-gateway
                    '''
                }
            }
        }
    }

    post {
        success {
            echo "‚úÖ All microservices deployed successfully to AKS: ${AKS_CLUSTER}"
        }
        failure {
            echo "‚ùå Deployment failed! Check Jenkins logs for error details."
        }
    }
}
